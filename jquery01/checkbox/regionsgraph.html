<html>
<head>
    <title>jQuery Sample</title>
    <script src ="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"> </script> 
    <script src ="data.js"> </script> 
    <style>
        #graph {
            border: 1px solid black;
            margin-left: 100px;
            width: 500px;
        }
        .level1 {
            margin-left: 25px;
            margin-right: 25px;
            margin-top: 10px;
            margin-bottom: 10px;
            border: 1px solid black;
        }
        .level2 {
            margin-left: 25px;
            margin-right: 25px;
            margin-bottom: 10px;
            border: 1px solid black;
        }
        .level3 {
            margin-left: 25px;
            margin-right: 25px;
            margin-bottom: 10px;
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <div id="graph">
    </div>
    <script>
        var regionsDict = {};
        var subRegions = regionsGraph.subregions;
        var members = subRegions.members;
        
        for (var i = 0; i < members.length; i++) {
            var obj = {};
            obj.parentId = null;
            obj.member = members[i];
            regionsDict[members[i].shippingRegionId] = obj;
        }

        var graph = document.getElementById("graph");

        for (var i = 0; i < regionsGraph.parentShippingRegion.subregionIds.length; i++) {
            process(regionsGraph.parentShippingRegion.subregionIds[i], 1, regionsGraph.parentShippingRegion.shippingRegionId, graph);
        }

        function process(subRegionId, level, parentId, container) {
            if (regionsDict[subRegionId]) {
                //update node's parentId
                regionsDict[subRegionId].parentId = parentId;

                var subRegion = regionsDict[subRegionId]
                var className = 'level' + level;

                //process root
                var div = document.createElement('div');
                div.className = className;
                
                var cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.id = subRegion.member.shippingRegionId;
                cb.addEventListener('change', function (e) {
                    handleChange(this);
                });

                var lbl = document.createElement('label');
                lbl.htmlFor = subRegion.member.shippingRegionId;
                lbl.appendChild(document.createTextNode(subRegion.member.displayName));

                div.appendChild(cb);
                div.appendChild(lbl);

                container.appendChild(div);

                if (subRegion.member.subregionIds.length > 0) {

                }

                //recursive call
                for (var i = 0; i < subRegion.member.subregionIds.length; i++) {
                    process(subRegion.member.subregionIds[i], level + 1, subRegion.member.shippingRegionId, div);
                }
            }
        }

        function handleChange(element) {
            //check/uncheck all descendant
            var val = element.checked;
            var region = regionsDict[element.id];
            for (i = 0; i < region.member.subregionIds.length; i++) {
                cascadeDown(region.member.subregionIds[i], val);
            }

            bubleUp(region, val);
        }

        function cascadeDown(regionId, val) {
            var element = document.getElementById(regionId);
            element.checked = val;

            //recursive call
            var region = regionsDict[regionId];
            if (region.member.subregionIds.length > 0) {
                for (j = 0; j < region.member.subregionIds.length; j++) {
                    cascadeDown(region.member.subregionIds[j], val);
                }
            }
        }

        function bubleUp(region, val) {
            //uncheck parent if one of its children is unchecked
            if (val == false) {
                if (region.parentId) {
                    var parentId = region.parentId;
                    var parent = document.getElementById(parentId);
                    if (parent) {
                        parent.checked = false;
                    }
                }
            }
        }
    </script>
</body>
</html>
